stages:
  - build
  - test
  - build_docker_image
  - deploy

build:
  stage: build
  image: golang:1.22.1
  script:
    - go mod download
    - go mod verify
    - go build -v -o cicd-service-go ./cmd/app

test:
  stage: test
  image: golang:1.22.1
  script:
    - go test -v ./...

build_docker_image:
  stage: build_docker_image
  image: docker:26.1.1-dind-alpine3.19
  script:
    - docker build -t registry.local:5000/cicd-service-go:gitlab-test .
    - docker push registry.local:5000/cicd-service-go:gitlab-test

deploy:
  stage: deploy
  image: registry.local:5000/cicd-ansible:latest
  script:
    - cd ./ansible/
    - ansible-playbook --inventory inventories/hosts-service.ini playbooks/deploy.yml
